# Flask 程序文档

## 程序概述
本 Flask 应用程序旨在提供一个服务接口，用于管理和监控电池测试任务。它支持任务的添加、状态查询、结果提交和设备状态检查等功能。

## 环境依赖
- Python 3.x
- Flask
- Werkzeug
- threading
- time
- queue
- math

## 主要组件
### 类定义
- ResultA: 存储“全部”模式下的测试结果，包括电压和阻抗。
- ResultS: 存储“单个”模式下的测试结果，包括电池单元 ID、频率、电压、阻抗等。
- Task: 表示一个测试任务，包含任务 ID、模式和结果。

### 主要函数
- exist_task(task_id): 检查指定的任务 ID 是否存在于任务队列中。
- _update(): 触发服务器更新操作。
- _is_online(): 检查设备是否在线。
- index(): 根目录请求重定向到 /index.html。
- update(): 处理更新请求。
- api(): 返回 API 版本。
- h_init(): 初始化设备状态。
- h_get_task(): 获取当前待执行的任务。
- h_submit_result(): 提交任务结果。
- c_add_task(): 添加新的测试任务。
- h_cur_task(): 获取当前正在执行的任务 ID。
- c_is_online(): 检查设备在线状态。
- c_battery_count(): 获取电池数量。
- c_get_result(): 根据任务 ID 获取测试结果。

## API 接口
### 首页重定向 (/)
- 方法: GET
- 描述: 访问根URL时，将用户重定向到/index.html。这通常用于提供应用程序的主界面。

### 更新 (/update)
- 方法: GET
- 参数: token - 用于验证请求的安全令牌。
- 描述: 允许远程触发服务器的更新过程。如果提供的token与服务器预设的TOKEN匹配，将启动一个新线程执行更新操作。

### API版本 (/api)
- 方法: GET
- 描述: 返回当前API的版本号，例如"2024"。

### 初始化 (/api/h/init)
- 方法: POST
- 数据: JSON格式，包含battery_count字段，表示电池数量。
- 描述: 初始化硬件设备，设置电池数量。如果请求中没有提供battery_count，返回错误。

### 获取任务 (/api/h/get_task)
- 方法: GET
- 描述: 从任务队列中获取下一个待执行的任务。如果当前有正在执行的任务，该任务将被清除。如果任务队列为空，返回"null"。

### 提交结果 (/api/h/submit_result)
- 方法: POST
- 数据: ASCII编码的字符串，使用|分隔不同的字段，包括任务ID、任务类型、以及根据任务类型可能的其他数据。
- 描述: 提交任务执行结果。根据任务类型（单个或全部），解析并存储结果数据。

### 添加任务 (/api/c/add_task)
- 方法: POST
- 数据: JSON格式，包含任务类型（type）、以及根据类型可能的其他数据（如cell_id、freq、mode）。
- 描述: 向任务队列中添加新任务。验证任务类型和数据的有效性。

### 当前任务 (/api/h/cur_task)
- 方法: GET
- 描述: 返回当前正在执行的任务ID。如果没有正在执行的任务且任务队列为空，则返回特定状态表示没有任务。

### 设备在线状态 (/api/c/is_online)
- 方法: GET
- 描述: 检查设备是否在线。基于最后一次心跳查询的时间判断。

### 电池数量 (/api/c/battery_count)
- 方法: GET
- 描述: 返回当前设置的电池数量。如果设备不在线，返回错误。

### 获取结果 (/api/c/get_result)
- 方法: GET
- 参数: task_id - 查询结果的任务ID。
- 描述: 根据任务ID获取执行结果。如果任务还在队列中或正在处理，返回等待状态；如果找不到任务，返回错误。

## 运行程序
1. 确保所有依赖已安装。
2. 在终端中运行 `python app.py` 启动 Flask 服务器。
3. 通过浏览器或 API 工具访问定义的接口进行操作。